@page "/messages"
@inject IChatService ChatService
@inject UserService UserService
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager NavManager
@inject IJSRuntime JS

@using System.Security.Claims
@using System.Linq
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.SignalR.Client
@using global::RentConnect.API.RentConnect.Presentation.DTOs
@using global::RentConnect.Presentation.UI.IServices
@using global::RentConnect.Presentation.UI.Services
@rendermode InteractiveServer

<style>
    body {
        background-color: #f3f4f8;
    }

    .chat-shell {
        max-width: 1100px;
        margin: 2.5rem auto;
    }

    .chat-container {
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
        height: 650px;
        background: linear-gradient(135deg, #f9fafb 0%, #eef2ff 100%);
    }

    .chat-sidebar {
        background: #ffffff;
        border-right: 1px solid #e5e7eb;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .chat-sidebar-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-sidebar-title {
        font-weight: 700;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

        .chat-sidebar-title span.icon {
            width: 30px;
            height: 30px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: #fff;
            font-size: 0.9rem;
        }

    .chat-search {
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #e5e7eb;
    }

        .chat-search input {
            font-size: 0.9rem;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            padding-left: 2.1rem;
            background: #f9fafb;
        }

        .chat-search .search-icon {
            position: absolute;
            left: 1.7rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #9ca3af;
        }

    .conversation-list {
        flex: 1;
        overflow-y: auto;
    }

    .conversation-item {
        border: none;
        border-bottom: 1px solid #f3f4f6;
        padding: 0.85rem 1.25rem;
        cursor: pointer;
        transition: background-color 0.16s, transform 0.12s;
        background: transparent;
    }

        .conversation-item:hover {
            background-color: #f3f4ff;
            transform: translateX(2px);
        }

        .conversation-item.active {
            background: linear-gradient(90deg, #e0f2fe, #dbeafe);
            border-left: 4px solid #2563eb;
        }

    .conversation-mainline {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.25rem;
    }

    .conversation-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .conversation-lastmsg {
        font-size: 0.82rem;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 220px;
    }

    .conversation-time {
        font-size: 0.75rem;
        color: #9ca3af;
        white-space: nowrap;
    }

    .conversation-avatar {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: linear-gradient(135deg, #2563eb, #7c3aed);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 600;
        margin-right: 0.6rem;
    }

    .badge-unread {
        font-size: 0.7rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
    }

    .chat-window {
        background-color: #f9fafb;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 1rem 1.25rem;
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 0.6rem;
    }

    .chat-header-name {
        font-weight: 600;
        font-size: 1rem;
    }

    .chat-header-sub {
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        scroll-behavior: smooth;
    }

    .message-row {
        margin-bottom: 0.25rem;
    }

    .chat-bubble {
        display: inline-block;
        padding: 0.55rem 0.9rem;
        border-radius: 18px;
        max-width: 78%;
        word-break: break-word;
        font-size: 0.92rem;
        position: relative;
    }

        .chat-bubble.mine {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble.theirs {
            background: #e5e7eb;
            color: #111827;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

    .chat-meta {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-top: -2px;
        margin-bottom: 4px;
    }

    .chat-input {
        background-color: #ffffff;
        border-top: 1px solid #e5e7eb;
        padding: 0.7rem 1rem;
    }

        .chat-input .input-group {
            border-radius: 999px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
        }

        .chat-input input {
            border: none;
            font-size: 0.95rem;
        }

            .chat-input input:focus {
                box-shadow: none;
            }

        .chat-input button {
            border-radius: 0;
            font-weight: 600;
            padding-inline: 1.3rem;
        }

    .chat-placeholder {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        flex-direction: column;
        gap: 0.6rem;
    }

    .chat-placeholder-icon {
        width: 52px;
        height: 52px;
        border-radius: 999px;
        background: #e5edff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: #4f46e5;
    }

    .date-separator {
        display: inline-block;
        padding: 0.15rem 0.8rem;
        border-radius: 999px;
        background-color: #e5e7eb;
        font-size: 0.78rem;
        color: #4b5563;
    }

    /* خيارات الرسالة (Edit/Delete) */
    .msg-actions {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.15s ease;
        font-size: 0.75rem;
    }

    .message-row.mine:hover .msg-actions {
        opacity: 1;
        visibility: visible;
    }

    .action-link {
        cursor: pointer;
        text-decoration: underline;
        text-underline-offset: 2px;
    }

    .edited-label {
        font-size: 0.7rem;
        color: #9ca3af;
        margin-left: 4px;
        font-style: italic;
    }

    .chat-bubble.editing {
        background: #e5e7eb;
        color: #111827;
    }

    .edit-input {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        width: 100%;
    }

    .inline-edit-actions {
        margin-top: 0.3rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.3rem;
    }

    @@media (max-width: 768px) {
        .chat-shell {
            margin: 0;
            max-width: 100%;
        }

        .chat-container {
            height: auto;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
        }

        .chat-sidebar {
            border-right: none;
            border-bottom: 1px solid #e5e7eb;
        }

        .chat-window {
            height: auto;
        }

        .chat-messages {
            max-height: calc(100vh - 220px);
        }
        /* في الموبايل نخلي الخيارات ظاهرة دائماً لرسائلك */
        .msg-actions {
            opacity: 1;
            visibility: visible;
        }
    }
</style>

<PageTitle>Messages</PageTitle>

<div class="chat-shell">
    <div class="row chat-container">
        <!-- Sidebar -->
        <div class="col-md-4 chat-sidebar">
            <div class="chat-sidebar-header">
                <div class="chat-sidebar-title">
                    <span class="icon">
                        <i class="fas fa-comments"></i>
                    </span>
                    <span>Messages</span>
                </div>
            </div>

            <div class="chat-search position-relative">
                <span class="search-icon">
                    <i class="fas fa-search"></i>
                </span>
                <input class="form-control" placeholder="Search chats..."
                       @bind="searchText" @bind:event="oninput" />
            </div>

            <div class="conversation-list">
                @foreach (var convo in FilteredConversations)
                {
                    <div class="conversation-item @(selectedConversation?.ConversationId == convo.ConversationId ? "active" : "")"
                         @onclick="() => OnConversationClicked(convo)">
                        <div class="d-flex align-items-center">
                            <div class="conversation-avatar">
                                @GetInitials(convo.Participant)
                            </div>
                            <div class="flex-grow-1">
                                <div class="conversation-mainline">
                                    <div class="conversation-name">
                                        @convo.Participant
                                        @if (convo.UnreadCount > 0)
                                        {
                                            <span class="badge bg-danger text-white badge-unread">@convo.UnreadCount</span>
                                        }
                                    </div>
                                    <div class="conversation-time">
                                        @convo.LastTimestamp?.ToLocalTime().ToString("HH:mm")
                                    </div>
                                </div>
                                <div class="conversation-lastmsg">
                                    @(!string.IsNullOrWhiteSpace(convo.LastMessage) ? convo.LastMessage : "No messages yet")
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (!FilteredConversations.Any())
                {
                    <div class="text-center text-muted py-4" style="font-size:0.9rem;">
                        No conversations found.
                    </div>
                }
            </div>
        </div>

        <!-- Chat window -->
        <div class="col-md-8 chat-window" id="chatWindow">
            @if (selectedConversation != null)
            {
                <div class="chat-header">
                    <div class="chat-header-left">
                        <div class="conversation-avatar">
                            @GetInitials(selectedConversation.Participant)
                        </div>
                        <div>
                            <div class="chat-header-name">@selectedConversation.Participant</div>
                            <div class="chat-header-sub">Chat started for a RentConnect item</div>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-danger" @onclick="DeleteCurrentConversation">
                            <i class="fas fa-trash-alt me-1"></i> Delete chat
                        </button>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    @foreach (var group in MessageGroups)
                    {
                        <div class="text-center my-2">
                            <span class="date-separator">@FormatDate(group.Key)</span>
                        </div>

                        @foreach (var msg in group)
                        {
                            var isMine = msg.SenderId == currentUserId;
                            var canEdit = isMine && (DateTime.UtcNow - msg.Timestamp) <= TimeSpan.FromMinutes(1);

                            <div class="message-row @(isMine ? "mine" : "theirs")">
                                @if (editingMessageId == msg.Id && isMine)
                                {
                                    <div class="chat-bubble editing">
                                        <input class="edit-input"
                                               @bind="editingText" @bind:event="oninput"
                                               @onkeydown="(e) => HandleInlineEditKeyDown(e, msg)" />
                                        <div class="inline-edit-actions">
                                            <button class="btn btn-sm btn-success" @onclick="() => SaveEdit(msg)">Save</button>
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit">Cancel</button>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="chat-bubble @(isMine ? "mine" : "theirs")">
                                        @msg.Content
                                    </div>
                                }

                                <div class="chat-meta d-flex @(isMine ? "justify-content-end" : "justify-content-start") align-items-center">
                                    <span>@msg.Timestamp.ToLocalTime().ToString("HH:mm")</span>

                                    @if (editedMessages.Contains(msg.Id))
                                    {
                                        <span class="edited-label">(edited)</span>
                                    }

                                    @if (isMine && msg.IsRead)
                                    {
                                        <span class="edited-label ms-1">Seen</span>
                                    }

                                    @if (canEdit && editingMessageId != msg.Id)
                                    {
                                        <div class="msg-actions ms-2">
                                            <span class="text-primary action-link" @onclick="() => StartEdit(msg)">Edit</span>
                                            <span class="text-danger action-link ms-2" @onclick="() => DeleteMessage(msg)">Delete</span>
                                        </div>
                                    }
                                    else if (isMine && editingMessageId != msg.Id)
                                    {
                                        <div class="msg-actions ms-2">
                                            <span class="text-danger action-link" @onclick="() => DeleteMessage(msg)">Delete</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>

                <div class="chat-input">
                    <div class="input-group">
                        <input class="form-control"
                               placeholder="Type a message..."
                               @bind="newMessage" @bind:event="oninput"
                               @onkeydown="HandleKeyDown" />
                        <button class="btn btn-primary" @onclick="SendMessage">
                            Send
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="chat-placeholder">
                    <div class="chat-placeholder-icon">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <div>Select a conversation to start chatting</div>
                </div>
            }
        </div>
    </div>
</div>

<script>
    window.scrollToBottom = function (elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        el.scrollTop = el.scrollHeight;
    };

    window.scrollToElement = function (elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    };
</script>

@code {
    private string? currentUserId;
    private List<ConversationDto> conversations = new();
    private ConversationDto? selectedConversation;
    private List<MessageDto> messages = new();
    private string newMessage = "";
    private string searchText = "";

    private bool scrollToBottomRequested;
    private bool scrollToChatWindowRequested;

    // للتعديل
    private Guid? editingMessageId;
    private string editingText = "";
    private HashSet<Guid> editedMessages = new();

    // ===== SignalR =====
    private HubConnection? hubConnection;
    private bool hubStarted = false;

    // نفس الرابط اللي استخدمته بصفحة تفاصيل المنتج
    private readonly string chatHubUrl = "https://localhost:7087/chathub";

    private IEnumerable<IGrouping<DateTime, MessageDto>> MessageGroups =>
        messages
            .OrderBy(m => m.Timestamp)
            .GroupBy(m => m.Timestamp.ToLocalTime().Date);

    private IEnumerable<ConversationDto> FilteredConversations =>
        string.IsNullOrWhiteSpace(searchText)
            ? conversations
            : conversations.Where(c =>
                c.Participant?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true);

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthProvider.GetAuthenticationStateAsync();
        currentUserId =
            auth.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ??
            auth.User.FindFirst("sub")?.Value;

        if (string.IsNullOrEmpty(currentUserId))
            return;

        conversations = (await ChatService.GetUserConversationsAsync(currentUserId))
            .OrderByDescending(c => c.LastTimestamp)
            .ToList();

        foreach (var convo in conversations)
        {
            var user = await UserService.GetUserByIdAsync(convo.ParticipantId);
            convo.Participant = user?.FullName ?? "Unknown";
        }

        // ✅ جهّز SignalR مرة واحدة
        await EnsureHubConnectedAsync();

        // فتح محادثة من الكويري سترينغ (cid)
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("cid", out var cidVal) &&
            Guid.TryParse(cidVal, out var cid))
        {
            var existing = conversations.FirstOrDefault(c => c.ConversationId == cid);
            if (existing != null)
            {
                await LoadMessages(existing);
                return;
            }
        }

        // فتح/إنشاء محادثة من receiverId + itemId
        if (query.TryGetValue("receiverId", out var receiverIdVal) &&
            query.TryGetValue("itemId", out var itemIdVal) &&
            Guid.TryParse(itemIdVal, out var parsedItemId) &&
            !string.IsNullOrWhiteSpace(receiverIdVal))
        {
            try
            {
                var convo = await ChatService.GetOrCreateConversationAsync(parsedItemId, currentUserId, receiverIdVal!);

                if (!conversations.Any(c => c.ConversationId == convo.ConversationId))
                {
                    var user = await UserService.GetUserByIdAsync(receiverIdVal!);
                    convo.ParticipantId = receiverIdVal!;
                    convo.Participant = user?.FullName ?? "Unknown";
                    conversations.Add(convo);

                    conversations = conversations
                        .OrderByDescending(c => c.LastTimestamp)
                        .ToList();
                }

                await LoadMessages(convo);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error creating or loading conversation: {ex.Message}");
            }
        }
    }

    private async Task EnsureHubConnectedAsync()
    {
        if (hubConnection != null && hubStarted)
            return;

        hubConnection = new HubConnectionBuilder()
            .WithUrl(chatHubUrl)
            .WithAutomaticReconnect()
            .Build();

        // ✅ استقبال الرسائل فوراً (نفس event اللي استخدمته بصفحة item details)
        hubConnection.On<string, string, DateTime>("ReceiveMessage", async (senderId, msg, timestamp) =>
        {
            try
            {
                // لو ما فيه محادثة مفتوحة، ما نضيف الرسالة هنا (تقدر توسعها لاحقاً للتنبيهات)
                if (selectedConversation == null || string.IsNullOrEmpty(currentUserId))
                    return;

                // لو الرسالة مني أنا، نتجاهلها (عشان ما تتكرر لأننا نسوي reload بعد الإرسال)
                if (senderId == currentUserId)
                    return;

                // لازم تكون الرسالة من الطرف اللي أنا فاتح محادثته
                if (senderId != selectedConversation.ParticipantId)
                    return;

                messages.Add(new MessageDto
                    {
                        SenderId = senderId,
                        ReceiverId = currentUserId!,
                        Content = msg,
                        Timestamp = timestamp,
                        ItemId = selectedConversation.ItemId
                    });

                // حدّث القائمة الجانبية
                var target = conversations.FirstOrDefault(c => c.ConversationId == selectedConversation.ConversationId);
                if (target != null)
                {
                    target.LastMessage = msg;
                    target.LastTimestamp = timestamp;
                }

                scrollToBottomRequested = true;
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"SignalR ReceiveMessage error: {ex.Message}");
            }
        });

        await hubConnection.StartAsync();
        hubStarted = true;
    }

    private async Task OnConversationClicked(ConversationDto convo)
    {
        await LoadMessages(convo);
    }

    private async Task LoadMessages(ConversationDto convo)
    {
        selectedConversation = convo;

        messages = await ChatService.GetMessagesByConversationIdAsync(convo.ConversationId, currentUserId!);

        var target = conversations.FirstOrDefault(c => c.ConversationId == convo.ConversationId);
        if (target != null)
            target.UnreadCount = 0;

        // ✅ انضم لقروب المحادثة (حسب ItemId مثل شغلك السابق)
        await EnsureHubConnectedAsync();
        if (hubConnection != null && hubStarted)
        {
            try
            {
                await hubConnection.InvokeAsync("JoinItemGroup", convo.ItemId.ToString());
            }
            catch (Exception ex)
            {
                Console.WriteLine($"JoinItemGroup error: {ex.Message}");
            }
        }

        scrollToBottomRequested = true;
        scrollToChatWindowRequested = true;

        await InvokeAsync(StateHasChanged);
    }

    private async Task SendMessage()
    {
        if (selectedConversation == null || string.IsNullOrWhiteSpace(newMessage) || currentUserId == null)
            return;

        var trimmed = newMessage.Trim();
        if (string.IsNullOrWhiteSpace(trimmed))
            return;

        var outgoing = new MessageDto
            {
                ItemId = selectedConversation.ItemId,
                SenderId = currentUserId,
                ReceiverId = selectedConversation.ParticipantId,
                Content = trimmed,
                Timestamp = DateTime.UtcNow
            };

        // 1) خزّن في الداتابيس (HTTP)
        await ChatService.SendMessageAsync(outgoing);

        // 2) ابعث realtime للطرف الثاني (SignalR)
        if (hubConnection != null && hubStarted)
        {
            try
            {
                await hubConnection.InvokeAsync(
                    "SendMessage",
                    selectedConversation.ItemId.ToString(),
                    outgoing.SenderId,
                    outgoing.ReceiverId,
                    outgoing.Content
                );
            }
            catch (Exception ex)
            {
                Console.WriteLine($"SendMessage hub error: {ex.Message}");
            }
        }

        // 3) حدّث القائمة الجانبية مباشرة (حسن التجربة)
        var target = conversations.FirstOrDefault(c => c.ConversationId == selectedConversation.ConversationId);
        if (target != null)
        {
            target.LastMessage = outgoing.Content;
            target.LastTimestamp = outgoing.Timestamp;
        }

        // 4) عشان تجيب Id الصحيح من السيرفر (زي ما كنت تسوي)
        await LoadMessages(selectedConversation);

        newMessage = "";
    }

    private Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            _ = SendMessage();
        }
        return Task.CompletedTask;
    }

    private void StartEdit(MessageDto msg)
    {
        if (msg.SenderId != currentUserId) return;

        editingMessageId = msg.Id;
        editingText = msg.Content;
    }

    private async Task SaveEdit(MessageDto msg)
    {
        if (!editingMessageId.HasValue || editingMessageId.Value != msg.Id)
            return;

        var trimmed = editingText?.Trim();
        if (string.IsNullOrEmpty(trimmed))
            return;

        await ChatService.UpdateMessageAsync(msg.Id, trimmed);

        msg.Content = trimmed;
        editedMessages.Add(msg.Id);

        editingMessageId = null;
        editingText = "";
        await InvokeAsync(StateHasChanged);
    }

    private void CancelEdit()
    {
        editingMessageId = null;
        editingText = "";
    }

    private Task HandleInlineEditKeyDown(KeyboardEventArgs e, MessageDto msg)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            _ = SaveEdit(msg);
        }
        else if (e.Key == "Escape")
        {
            CancelEdit();
        }
        return Task.CompletedTask;
    }

    private async Task DeleteMessage(MessageDto msg)
    {
        if (msg.SenderId != currentUserId) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this message?");
        if (!confirmed) return;

        await ChatService.DeleteMessageAsync(msg.Id);
        messages.Remove(msg);
        editedMessages.Remove(msg.Id);

        scrollToBottomRequested = true;
        await InvokeAsync(StateHasChanged);
    }

    private async Task DeleteCurrentConversation()
    {
        if (selectedConversation == null) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this chat?");
        if (!confirmed) return;

        await ChatService.DeleteConversationAsync(selectedConversation.ConversationId);

        conversations.Remove(selectedConversation);
        selectedConversation = null;
        messages.Clear();
        editedMessages.Clear();

        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (scrollToBottomRequested)
        {
            scrollToBottomRequested = false;
            await JS.InvokeVoidAsync("scrollToBottom", "chatMessages");
        }

        if (scrollToChatWindowRequested)
        {
            scrollToChatWindowRequested = false;
            await JS.InvokeVoidAsync("scrollToElement", "chatWindow");
        }
    }

    private string GetInitials(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "?";

        var parts = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1)
            return parts[0][0].ToString().ToUpper();

        return (char.ToUpper(parts[0][0]) + "" + char.ToUpper(parts[1][0]));
    }

    private string FormatDate(DateTime date)
    {
        var today = DateTime.Now.Date;
        var target = date.Date;

        if (target == today)
            return "Today";
        if (target == today.AddDays(-1))
            return "Yesterday";

        return target.ToString("dd MMM yyyy");
    }

    public void Dispose()
    {
        if (hubConnection != null)
        {
            _ = hubConnection.DisposeAsync();
        }
    }
}