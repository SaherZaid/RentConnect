@page "/items"
@inject NavigationManager NavManager
@inject IItemService ItemService
@inject IFavoriteService FavoriteService
@inject IReviewService ReviewService
@inject AuthenticationStateProvider AuthProvider
@inject IJSRuntime JS

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Web
@using global::RentConnect.Presentation.UI.RentConnect.Presentation.DTOs
@using global::RentConnect.Presentation.UI.IServices
@rendermode InteractiveServer

<style>
    body {
        background-color: #f3f4f6;
    }

    .items-page-shell {
        padding-top: 2.5rem;
        padding-bottom: 3rem;
    }

    .items-header {
        margin-bottom: 1.5rem;
    }

    .items-breadcrumb {
        font-size: 0.8rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .items-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .items-title {
        font-weight: 800;
        color: #0f172a;
        margin: 0;
    }

    .items-subtitle {
        color: #6b7280;
        font-size: 0.92rem;
        margin-top: 0.2rem;
    }

    .items-count-pill {
        font-size: 0.8rem;
        padding: 0.25rem 0.8rem;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0369a1;
        border: 1px solid #bae6fd;
        white-space: nowrap;
    }

    /* 🌟 Search / Filters box */
    .search-box {
        background: #ffffff;
        padding: 20px 22px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        margin-bottom: 2rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .search-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .search-title-block {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .search-icon-circle {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        color: #fff;
        box-shadow: 0 10px 22px rgba(37, 99, 235, 0.35);
        font-size: 1.1rem;
    }

    .search-title-text {
        line-height: 1.2;
    }

        .search-title-text h5 {
            margin: 0;
            font-weight: 700;
            color: #0f172a;
        }

        .search-title-text small {
            color: #64748b;
            font-size: 0.78rem;
        }

    .search-chip {
        font-size: 0.75rem;
        padding: 0.2rem 0.7rem;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0369a1;
        border: 1px solid #bae6fd;
        white-space: nowrap;
    }

    .search-controls {
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.2fr) minmax(0, 0.9fr) minmax(0, 1.1fr);
        gap: 0.6rem;
        align-items: center;
        margin-bottom: 0.6rem;
    }

    .search-main-input {
        position: relative;
    }

        .search-main-input .form-control {
            padding-left: 2.2rem;
            border-radius: 999px;
            border-color: #e2e8f0;
            font-size: 0.95rem;
        }

            .search-main-input .form-control:focus {
                box-shadow: 0 0 0 1px #2563eb33;
                border-color: #2563eb;
            }

        .search-main-input .search-input-icon {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 0.9rem;
        }

    .search-select .form-select {
        border-radius: 999px;
        font-size: 0.9rem;
        border-color: #e2e8f0;
    }

    .search-toggle {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.4rem;
        white-space: nowrap;
        font-size: 0.86rem;
        color: #0f172a;
    }

        .search-toggle .form-check-input {
            cursor: pointer;
        }

    .search-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.4rem;
    }

        .search-actions .btn-search {
            border-radius: 999px;
            padding-inline: 1.7rem;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.3);
        }

    /* Cards */
    .item-card {
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.25);
        transition: transform 0.14s ease, box-shadow 0.14s ease, border-color 0.14s ease;
        background-color: #ffffff;
    }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.15);
            border-color: rgba(37, 99, 235, 0.45);
        }

    .item-card-img {
        object-fit: cover;
        height: 200px;
    }

    .item-card-title {
        font-weight: 600;
        font-size: 1.02rem;
        margin-bottom: 0.3rem;
        color: #0f172a;
    }

    .item-card-desc {
        font-size: 0.88rem;
        color: #6b7280;
        max-height: 3.3em;
        overflow: hidden;
    }

    .item-card-meta {
        font-size: 0.8rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 0.7rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .badge-soft {
        font-size: 0.72rem;
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
    }

    .badge-city {
        background-color: #eff6ff;
        color: #1d4ed8;
    }

    .badge-ship {
        background-color: #ecfdf5;
        color: #15803d;
    }

    .badge-category {
        background-color: #f3e8ff;
        color: #7c3aed;
    }

    .item-card-footer {
        margin-top: auto;
    }

    .price-text {
        font-size: 1rem;
        font-weight: 700;
        color: #16a34a;
    }

    .price-unit {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .btn-view-details {
        font-size: 0.85rem;
        border-radius: 999px;
        font-weight: 600;
    }

    /* Pagination */
    .pagination .page-link {
        border-radius: 999px !important;
        margin: 0 0.15rem;
        font-size: 0.9rem;
    }

    .pagination .page-item.active .page-link {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    @@media (max-width: 768px) {
        .search-controls {
            grid-template-columns: minmax(0, 1fr);
        }

        .search-actions .btn-search {
            width: 100%;
            justify-content: center;
        }

        .items-title-row {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    /* ⭐ Rating badge on cards */
    .item-rating-row {
        display: flex;
        align-items: center;
        gap: .35rem;
        margin-top: .35rem;
    }

    .item-stars i {
        font-size: .85rem;
        margin-right: 1px;
    }

    .item-rating-score {
        font-size: .82rem;
        font-weight: 700;
        color: #0f172a;
    }

    .item-rating-count {
        font-size: .78rem;
        color: #6b7280;
    }
</style>

<div class="items-page-shell">
    <div class="container">
        <!-- Header -->
        <div class="items-header">
            <div class="items-breadcrumb">
                Home / Items
            </div>
            <div class="items-title-row">
                <div>
                    <h2 class="items-title">Browse items for rent</h2>
                    <p class="items-subtitle">
                        Use the filters below to find exactly what you need – by city, shipping and price.
                    </p>
                </div>
                <div class="items-count-pill">
                    @((items?.Count ?? 0)) item@(items?.Count == 1 ? "" : "s") found · Page @currentPage of @TotalPages
                </div>
            </div>
        </div>

        <!-- 🔍 Filters / Search -->
        <div class="search-box">
            <div class="search-header">
                <div class="search-title-block">
                    <div class="search-icon-circle">
                        <i class="bi bi-funnel"></i>
                    </div>
                    <div class="search-title-text">
                        <h5>Filter items</h5>
                        <small>Search, choose a city, shipping and sort by price</small>
                    </div>
                </div>
                <span class="search-chip">
                    Smart search · typo friendly
                </span>
            </div>

            <div class="search-controls">
                <!-- Search text -->
                <div class="search-main-input">
                    <i class="bi bi-search search-input-icon"></i>
                    <input class="form-control"
                           placeholder="Search items..."
                           @bind="searchTerm"
                           @bind:event="oninput"
                           @onkeydown="HandleSearchKeyDown" />
                </div>

                <!-- City -->
                <div class="search-select">
                    <select class="form-select" @bind="selectedCity">
                        <option value="">All Cities</option>
                        @foreach (var city in allCities)
                        {
                            <option value="@city">@city</option>
                        }
                    </select>
                </div>

                <!-- Shippable -->
                <div class="search-toggle">
                    <input class="form-check-input" type="checkbox" id="ship" @bind="filterShippable" />
                    <label class="form-check-label" for="ship">Shippable only</label>
                </div>

                <!-- Sort by -->
                <div class="search-select">
                    <select class="form-select" @bind="sortOrder">
                        <option value="">Sort by</option>

                        <option value="low">Price: Low to High</option>
                        <option value="high">Price: High to Low</option>

                        <option value="rating-high">Rating: High to Low</option>
                        <option value="rating-low">Rating: Low to High</option>
                    </select>
                </div>
            </div>

            <div class="search-actions">
                <button class="btn btn-primary btn-search" @onclick="ApplyFilters">
                    <i class="bi bi-arrow-repeat"></i>
                    Apply filters
                </button>
            </div>
        </div>

        <!-- Results -->
        @if (items == null)
        {
            <p>Loading...</p>
        }
        else if (!items.Any())
        {
            <div class="alert alert-info text-center">
                No items found. Try changing your search or filters.
            </div>
        }
        else
        {
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
                @foreach (var item in PagedItems)
                {
                    var isFavorite = favoriteIds.Contains(item.Id);

                    <div class="col">
                        <div class="card item-card h-100 position-relative">
                            <button class="btn position-absolute top-0 end-0 m-2"
                                    @onclick="() => ToggleFavorite(item.Id)"
                                    style="z-index: 10; background: rgba(255,255,255,0.9); border-radius: 50%;">
                                <i class="@(isFavorite ? "fas fa-heart text-danger" : "far fa-heart text-muted") fa-lg"></i>
                            </button>

                            @if (item.ImageUrls?.Any() == true)
                            {
                                <img src="@item.ImageUrls.First()" class="card-img-top item-card-img" />
                            }
                            else
                            {
                                <img src="https://via.placeholder.com/400x200?text=No+Image"
                                     class="card-img-top item-card-img" />
                            }

                            <div class="card-body d-flex flex-column">
                                <div class="item-card-title">@item.Name</div>
                                <p class="item-card-desc">@item.Description</p>

                                @{
                                    var stats = GetRating(item.Id);
                                }

                                <div class="item-rating-row">
                                    <div class="item-stars text-warning">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <i class="@(i <= Math.Floor(stats.Avg) ? "fas" : "far") fa-star"></i>
                                        }
                                    </div>
                                    <span class="item-rating-score">@stats.Avg.ToString("0.0")</span>
                                    <span class="item-rating-count">(@stats.Count)</span>
                                </div>

                                <div class="item-card-meta">
                                    @if (!string.IsNullOrWhiteSpace(item.City))
                                    {
                                        <span class="badge-soft badge-city">
                                            <i class="bi bi-geo-alt me-1"></i>@item.City
                                        </span>
                                    }

                                    @if (item.IsShippable)
                                    {
                                        <span class="badge-soft badge-ship">
                                            <i class="bi bi-truck me-1"></i>Shippable
                                        </span>
                                    }

                                    @if (!string.IsNullOrEmpty(item.CategoryName))
                                    {
                                        <span class="badge-soft badge-category">
                                            <i class="bi bi-tag me-1"></i>@item.CategoryName
                                        </span>
                                    }
                                </div>

                                <div class="item-card-footer mt-3 d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="price-text">@item.PricePerDay Kr</span>
                                        <span class="price-unit">/day</span>
                                    </div>
                                    <a href="/items/@item.Id" class="btn btn-sm btn-outline-primary btn-view-details">
                                        View details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            @if (TotalPages > 1)
            {
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">
                                Previous
                            </button>
                        </li>

                        @for (int i = 1; i <= TotalPages; i++)
                        {
                            <li class="page-item @(currentPage == i ? "active" : "")">
                                <button class="page-link" @onclick="() => ChangePage(i)">
                                    @i
                                </button>
                            </li>
                        }

                        <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">
                                Next
                            </button>
                        </li>
                    </ul>
                </nav>
            }
        }
    </div>
</div>

@code {
    private List<ItemDto> allItems = new();
    private List<ItemDto>? items;
    private HashSet<Guid> favoriteIds = new();
    private bool isAuthenticated = false;
    private string? currentUserId;
    private bool jsFavoritesLoaded = false;

    private Guid? selectedCategory;
    private string? searchTerm;
    private string? selectedCity;
    private bool filterShippable;
    private string? sortOrder;

    private List<string> allCities = new();

    // 🔢 Pagination
    private int pageSize = 12;           // 12 منتجات في الصفحة
    private int currentPage = 1;
    private int TotalPages =>
        items == null || items.Count == 0
            ? 1
            : (int)Math.Ceiling(items.Count / (double)pageSize);

    private IEnumerable<ItemDto> PagedItems =>
        items == null
            ? Enumerable.Empty<ItemDto>()
            : items
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize);

    // ⭐ Ratings cache (itemId -> (avg, count))
    private readonly Dictionary<Guid, (double Avg, int Count)> ratingCache = new();

    private (double Avg, int Count) GetRating(Guid itemId)
    {
        if (ratingCache.TryGetValue(itemId, out var v))
            return v;

        return (0.0, 0);
    }

    protected override async Task OnInitializedAsync()
    {
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("search", out var search))
            searchTerm = search;

        if (query.TryGetValue("city", out var city))
            selectedCity = city;

        if (query.TryGetValue("shippable", out var ship))
            filterShippable = ship == "true";

        if (query.TryGetValue("sortOrder", out var so))
            sortOrder = so;

        if (query.TryGetValue("categoryId", out var catIdStr) && Guid.TryParse(catIdStr, out var catId))
            selectedCategory = catId;

        allItems = (await ItemService.GetAllAsync()).ToList();
        // ⭐ Load ratings once for all items
        foreach (var it in allItems)
        {
            try
            {
                var revs = await ReviewService.GetByItemIdAsync(it.Id);
                var list = revs?.ToList() ?? new List<ReviewDto>();

                var avg = list.Count > 0 ? list.Average(r => r.Rating) : 0.0;
                ratingCache[it.Id] = (avg, list.Count);
            }
            catch
            {
                ratingCache[it.Id] = (0.0, 0);
            }
        }

        allCities = allItems
            .Where(i => !string.IsNullOrWhiteSpace(i.City))
            .Select(i => i.City!)
            .Distinct()
            .OrderBy(c => c)
            .ToList();

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        currentUserId = user.FindFirst(c => c.Type == "sub")?.Value
                        ?? user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

        if (isAuthenticated && currentUserId != null)
        {
            var favorites = await FavoriteService.GetFavoritesForUserAsync(currentUserId);
            favoriteIds = new(favorites);
        }

        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var filtered = allItems.AsEnumerable();

        // 🔍 بحث ذكي: كابيتال/سمول + أخطاء بسيطة
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var query = searchTerm.Trim().ToLowerInvariant();
            var words = query.Split(' ', StringSplitOptions.RemoveEmptyEntries);

            filtered = filtered.Where(i =>
            {
                var name = (i.Name ?? string.Empty).ToLowerInvariant();
                var desc = (i.Description ?? string.Empty).ToLowerInvariant();

                return MatchesSearch(name, desc, query, words);
            });
        }

        if (!string.IsNullOrWhiteSpace(selectedCity))
            filtered = filtered.Where(i => i.City == selectedCity);

        if (filterShippable)
            filtered = filtered.Where(i => i.IsShippable);

        if (selectedCategory != null && selectedCategory != Guid.Empty)
            filtered = filtered.Where(i => i.CategoryId == selectedCategory);

        if (sortOrder == "low")
        {
            filtered = filtered.OrderBy(i => i.PricePerDay);
        }
        else if (sortOrder == "high")
        {
            filtered = filtered.OrderByDescending(i => i.PricePerDay);
        }
       
        else if (sortOrder == "rating-high")
        {
            filtered = filtered.OrderByDescending(i => GetRating(i.Id).Avg);
        }
        else if (sortOrder == "rating-low")
        {
            filtered = filtered.OrderBy(i => GetRating(i.Id).Avg);
        }

        items = filtered.ToList();

        // كل ما تغير الفلتر، رجّع للصفحة الأولى
        currentPage = 1;
    }

    private bool MatchesSearch(string name, string desc, string query, string[] words)
    {
        if (string.IsNullOrEmpty(name) && string.IsNullOrEmpty(desc))
            return false;

        // تطابق مباشر
        if (name.Contains(query) || desc.Contains(query))
            return true;

        // أي كلمة منفردة
        if (words.Any(w => name.Contains(w) || desc.Contains(w)))
            return true;

        // تطابق تقريبي مع الجملة كاملة
        if (IsFuzzyMatch(name, query, 2) || IsFuzzyMatch(desc, query, 2))
            return true;

        // تطابق تقريبي مع الكلمات
        foreach (var w in words)
        {
            if (IsFuzzyMatch(name, w, 1) || IsFuzzyMatch(desc, w, 1))
                return true;
        }

        return false;
    }

    // Fuzzy match (Levenshtein)
    private bool IsFuzzyMatch(string source, string term, int maxDistance)
    {
        if (string.IsNullOrWhiteSpace(source) || string.IsNullOrWhiteSpace(term))
            return false;

        if (source.Contains(term))
            return true;

        if (Math.Abs(source.Length - term.Length) > maxDistance + 3)
            return false;

        var distance = LevenshteinDistance(source, term);
        return distance <= maxDistance;
    }

    private int LevenshteinDistance(string s, string t)
    {
        if (string.IsNullOrEmpty(s))
            return t.Length;
        if (string.IsNullOrEmpty(t))
            return s.Length;

        var n = s.Length;
        var m = t.Length;
        var d = new int[n + 1, m + 1];

        for (int i = 0; i <= n; i++)
            d[i, 0] = i;
        for (int j = 0; j <= m; j++)
            d[0, j] = j;

        for (int i = 1; i <= n; i++)
        {
            for (int j = 1; j <= m; j++)
            {
                int cost = (s[i - 1] == t[j - 1]) ? 0 : 1;

                d[i, j] = Math.Min(
                    Math.Min(
                        d[i - 1, j] + 1,
                        d[i, j - 1] + 1),
                    d[i - 1, j - 1] + cost
                );
            }
        }

        return d[n, m];
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isAuthenticated && !jsFavoritesLoaded)
        {
            jsFavoritesLoaded = true;
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "favorites");
            if (!string.IsNullOrEmpty(json))
            {
                var list = System.Text.Json.JsonSerializer.Deserialize<List<Guid>>(json);
                favoriteIds = new(list ?? []);
                StateHasChanged();
            }
        }
    }

    private async Task ToggleFavorite(Guid itemId)
    {
        if (favoriteIds.Contains(itemId))
        {
            favoriteIds.Remove(itemId);
            if (isAuthenticated && currentUserId != null)
            {
                await FavoriteService.RemoveFromFavoritesAsync(currentUserId, itemId);
            }
        }
        else
        {
            favoriteIds.Add(itemId);
            if (isAuthenticated && currentUserId != null)
            {
                await FavoriteService.AddToFavoritesAsync(currentUserId, itemId);
            }
        }

        if (!isAuthenticated)
        {
            var list = favoriteIds.ToList();
            var json = System.Text.Json.JsonSerializer.Serialize(list);
            await JS.InvokeVoidAsync("localStorage.setItem", "favorites", json);
        }
    }

    private void HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ApplyFilters();
        }
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > TotalPages)
            return;

        currentPage = page;
    }
}