@page "/profile"
@inject IItemService ItemService
@inject AuthenticationStateProvider AuthProvider
@inject IReviewService ReviewService
@inject IBookingService BookingService
@inject NavigationManager NavManager
@inject UserManager<ApplicationUser> UserManager

@using global::RentConnect.Presentation.UI.RentConnect.Presentation.DTOs
@using global::RentConnect.API.Enums
@using System.ComponentModel.DataAnnotations
@using global::RentConnect.API.RentConnect.Domain.Models
@using global::RentConnect.Presentation.UI.IServices
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Web
@rendermode InteractiveServer

<PageTitle>My Profile</PageTitle>

<style>
    body {
        background-color: #f3f4f6;
    }

    .profile-page-shell {
        padding-top: 2.5rem;
        padding-bottom: 3rem;
    }

    .profile-header {
        margin-bottom: 1.5rem;
    }

    .profile-breadcrumb {
        font-size: 0.8rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .profile-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .profile-title {
        font-weight: 800;
        color: #0f172a;
        margin: 0;
    }

    .profile-subtitle {
        color: #6b7280;
        font-size: 0.92rem;
        margin-top: 0.2rem;
    }

    .profile-pill {
        font-size: 0.8rem;
        padding: 0.25rem 0.8rem;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0369a1;
        border: 1px solid #bae6fd;
        white-space: nowrap;
    }

    /* Tabs */
    .profile-tabs {
        border-bottom: none;
        margin-bottom: 1.5rem;
        gap: 0.5rem;
    }

        .profile-tabs .nav-item {
            margin-bottom: -1px;
        }

        .profile-tabs .nav-link {
            border-radius: 999px;
            padding-inline: 1.4rem;
            padding-block: 0.55rem;
            font-weight: 500;
            color: #4b5563;
            border: 1px solid transparent;
            background-color: transparent;
        }

            .profile-tabs .nav-link.active {
                background-color: #ffffff;
                color: #111827;
                border-color: #e5e7eb;
                box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
            }

    /* Item cards (نفس ستايل صفحة items) */
    .item-card {
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.25);
        transition: transform 0.14s ease, box-shadow 0.14s ease, border-color 0.14s ease;
        background-color: #ffffff;
    }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.15);
            border-color: rgba(37, 99, 235, 0.45);
        }

    .item-card-img {
        object-fit: cover;
        height: 200px;
    }

    .item-card-title a {
        font-weight: 600;
        font-size: 1.02rem;
        color: #0f172a;
        text-decoration: none;
    }

        .item-card-title a:hover {
            text-decoration: underline;
        }

    .item-card-desc {
        font-size: 0.88rem;
        color: #6b7280;
        max-height: 3.3em;
        overflow: hidden;
    }

    .item-card-meta {
        font-size: 0.82rem;
        color: #6b7280;
        margin-top: 0.5rem;
    }

    .rating-stars span {
        font-size: 0.9rem;
    }

    /* 🌈 أزرار أكشن للكرت (Edit/Delete) */
    .btn-item-action {
        border-radius: 999px;
        font-size: 0.82rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        padding-inline: 0.75rem;
        padding-block: 0.35rem;
        border-width: 1px;
    }

    .btn-item-edit {
        border-color: #bfdbfe;
        color: #1d4ed8;
        background-color: #eff6ff;
    }

        .btn-item-edit:hover {
            background-color: #dbeafe;
            border-color: #93c5fd;
            color: #1d4ed8;
        }

    .btn-item-delete {
        border-color: #fecaca;
        color: #b91c1c;
        background-color: #fef2f2;
    }

        .btn-item-delete:hover {
            background-color: #fee2e2;
            border-color: #fecaca;
            color: #b91c1c;
        }

    .btn-item-action i {
        font-size: 0.9rem;
    }

    /* كرت تعديل البروفايل */
    .profile-edit-card {
        max-width: 600px;
        margin: auto;
        background: #ffffff;
        border-radius: 16px;
        padding: 1.8rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.2);
    }

        .profile-edit-card h4 {
            font-weight: 700;
            margin-bottom: 1rem;
            color: #0f172a;
        }

    .form-floating > label {
        color: #6b7280;
    }

    .form-floating > .form-control {
        border-radius: 0.75rem;
    }

    /* زر حفظ أنيق */
    .btn-profile-save {
        border-radius: 999px;
        font-weight: 600;
        padding-block: 0.55rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        box-shadow: 0 8px 22px rgba(37, 99, 235, 0.35);
    }

        .btn-profile-save i {
            font-size: 1rem;
        }

    /* Delete modal */
    .modal-backdrop-custom {
        background-color: rgba(15, 23, 42, 0.35);
    }

    .modal-content {
        border-radius: 1rem;
    }

    @@media (max-width: 768px) {
        .profile-title-row {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

@if (!isAuthenticated)
{
    <div class="container profile-page-shell">
        <div class="alert alert-warning text-center mt-5">
            Please log in to view your profile.
        </div>
    </div>
}
else
{
    <div class="profile-page-shell">
        <div class="container">

            <!-- Header -->
            <div class="profile-header">
                <div class="profile-breadcrumb">
                    Home / Profile
                </div>
                <div class="profile-title-row">
                    <div>
                        <h2 class="profile-title">My profile</h2>
                        <p class="profile-subtitle">
                            Manage your items and keep your account details up to date.
                        </p>
                    </div>
                    <div class="profile-pill">
                        @items.Count item@(items.Count == 1 ? "" : "s") listed
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs profile-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "items" ? "active" : "")"
                            @onclick='() => activeTab = "items"'
                            type="button" role="tab">
                        <i class="bi bi-box-seam me-1"></i> My Items
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "profile" ? "active" : "")"
                            @onclick='() => activeTab = "profile"'
                            type="button" role="tab">
                        <i class="bi bi-person-circle me-1"></i> Edit Profile
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                @if (activeTab == "items")
                {
                    <div class="tab-pane fade show active" role="tabpanel">
                        @if (!string.IsNullOrEmpty(deleteMessage))
                        {
                            <div class="alert @(deleteSuccess ? "alert-success" : "alert-danger") mb-4">
                                @deleteMessage
                            </div>
                        }

                        @if (items == null)
                        {
                            <p>Loading...</p>
                        }
                        else if (!items.Any())
                        {
                            <div class="alert alert-info">
                                You haven't added any items yet.
                            </div>
                        }
                        else
                        {
                            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
                                @foreach (var item in items)
                                {
                                    <div class="col">
                                        <div class="card item-card h-100">
                                            <img src="@item.ImageUrls.FirstOrDefault()"
                                                 class="card-img-top item-card-img" />

                                            <div class="card-body d-flex flex-column">
                                                <div class="item-card-title mb-1">
                                                    <a href="/items/@item.Id">
                                                        @item.Name
                                                    </a>
                                                </div>

                                                <p class="item-card-desc">@item.Description</p>

                                                <div class="item-card-meta mt-2">
                                                    <div>
                                                        <strong>@item.PricePerDay</strong> Kr/day
                                                    </div>

                                                    @if (item.AverageRating > 0)
                                                    {
                                                        <div class="rating-stars mt-1">
                                                            @for (int i = 1; i <= 5; i++)
                                                            {
                                                                <span class="@(i <= Math.Round(item.AverageRating) ? "text-warning" : "text-muted")">
                                                                    &#9733;
                                                                </span>
                                                            }
                                                            <span class="ms-1">
                                                                (@item.AverageRating.ToString("0.0"))
                                                            </span>
                                                        </div>
                                                    }

                                                    <div class="mt-1">
                                                        <strong>Bookings:</strong> @item.BookingCount
                                                    </div>
                                                </div>

                                                <div class="mt-auto d-flex gap-2 pt-3">
                                                    <button class="btn btn-item-action btn-item-edit w-100"
                                                            @onclick="() => EditItem(item.Id)">
                                                        <i class="bi bi-pencil-square"></i>
                                                        Edit
                                                    </button>
                                                    <button class="btn btn-item-action btn-item-delete w-100"
                                                            @onclick="() => ConfirmDelete(item.Id, item.Name)">
                                                        <i class="bi bi-trash3"></i>
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @if (showDeleteConfirmation)
                        {
                            <div class="modal fade show d-block" style="display:block;">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Confirm deletion</h5>
                                        </div>
                                        <div class="modal-body">
                                            Are you sure you want to delete <strong>@itemNameToDelete</strong>?
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                                            <button class="btn btn-danger" @onclick="DeleteItemConfirmed">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-backdrop fade show modal-backdrop-custom"></div>
                        }
                    </div>
                }
                else if (activeTab == "profile" && editModel != null)
                {
                    <div class="tab-pane fade show active" role="tabpanel">
                        <div class="profile-edit-card">
                            <h4>Edit profile</h4>

                            <EditForm Model="editModel" OnValidSubmit="UpdateProfile">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="text-danger" />

                                <div class="form-floating mb-3">
                                    <InputText @bind-Value="editModel.FullName" class="form-control" />
                                    <label>Full Name</label>
                                    <ValidationMessage For="@(() => editModel.FullName)" class="text-danger" />
                                </div>

                                <div class="form-floating mb-3">
                                    <InputText @bind-Value="editModel.Email" class="form-control" />
                                    <label>Email</label>
                                    <ValidationMessage For="@(() => editModel.Email)" class="text-danger" />
                                </div>

                                <div class="form-floating mb-3">
                                    <InputText @bind-Value="editModel.PhoneNumber" class="form-control" />
                                    <label>Phone Number</label>
                                    <ValidationMessage For="@(() => editModel.PhoneNumber)" class="text-danger" />
                                </div>

                                <button class="btn btn-primary w-100 btn-profile-save" type="submit">
                                    <i class="bi bi-check-circle"></i>
                                    Save changes
                                </button>

                                @if (!string.IsNullOrEmpty(profileMessage))
                                {
                                    <div class="alert @(profileSuccess ? "alert-success" : "alert-danger") mt-3">
                                        @profileMessage
                                    </div>
                                }
                            </EditForm>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "items";
    private List<ItemDto> items = new();
    private bool isAuthenticated = false;
    private string? userId;

    private Guid itemIdToDelete;
    private string? itemNameToDelete;
    private bool showDeleteConfirmation = false;

    private string? deleteMessage;
    private bool deleteSuccess = false;

    private EditProfileModel? editModel;
    private string? profileMessage;
    private bool profileSuccess;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userId = user.FindFirst(c => c.Type == "sub")?.Value
                  ?? user.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            items = (await ItemService.GetAllAsync())
                    .Where(i => i.OwnerId == userId)
                    .ToList();

            foreach (var item in items)
            {
                var bookings = await BookingService.GetByItemIdAsync(item.Id);
                item.BookingCount = bookings.Count();

                var reviews = await ReviewService.GetByItemIdAsync(item.Id);
                item.AverageRating = reviews.Any() ? reviews.Average(r => r.Rating) : 0;
            }

            var appUser = await UserManager.FindByIdAsync(userId);
            if (appUser != null)
            {
                editModel = new EditProfileModel
                    {
                        FullName = appUser.FullName,
                        Email = appUser.Email,
                        PhoneNumber = appUser.PhoneNumber
                    };
            }
        }
    }

    private void EditItem(Guid itemId)
    {
        NavManager.NavigateTo($"/edititem/{itemId}");
    }

    private void ConfirmDelete(Guid id, string name)
    {
        itemIdToDelete = id;
        itemNameToDelete = name;
        showDeleteConfirmation = true;
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
    }

    private async Task DeleteItemConfirmed()
    {
        try
        {
            await ItemService.DeleteAsync(itemIdToDelete);
            items = items.Where(i => i.Id != itemIdToDelete).ToList();

            deleteMessage = "Item deleted successfully.";
            deleteSuccess = true;
        }
        catch (HttpRequestException ex)
        {
            if (ex.Message.Contains("bookings associated"))
            {
                deleteMessage = "You cannot delete this item because it has active bookings.";
            }
            else
            {
                deleteMessage = "Failed to delete the item. Please try again later.";
            }

            deleteSuccess = false;
        }
        catch (Exception ex)
        {
            deleteMessage = $"Unexpected error: {ex.Message}";
            deleteSuccess = false;
        }

        showDeleteConfirmation = false;
    }

    private async Task UpdateProfile()
    {
        if (userId is null || editModel is null) return;

        var user = await UserManager.FindByIdAsync(userId);
        if (user is null)
        {
            profileMessage = "User not found.";
            profileSuccess = false;
            return;
        }

        user.FullName = editModel.FullName;
        user.Email = editModel.Email;
        user.UserName = editModel.Email;
        user.PhoneNumber = editModel.PhoneNumber;

        var result = await UserManager.UpdateAsync(user);

        if (result.Succeeded)
        {
            profileMessage = "Profile updated successfully.";
            profileSuccess = true;
        }
        else
        {
            profileMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            profileSuccess = false;
        }
    }

    public class EditProfileModel
    {
        [Required]
        public string FullName { get; set; } = "";

        [Required, EmailAddress]
        public string Email { get; set; } = "";

        [Required, Phone]
        public string PhoneNumber { get; set; } = "";
    }
}