@using global::RentConnect.API.Enums
@using global::RentConnect.API.RentConnect.Domain.Models
@using global::RentConnect.Presentation.UI.IServices
@using global::RentConnect.Presentation.UI.RentConnect.Presentation.DTOs
@using global::RentConnect.Presentation.UI.Components.Pages.Shared
@using global::RentConnect.Presentation.UI.Components.Layout


@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Routing
@implements IDisposable

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthProvider
@inject IBookingService BookingService
@inject IChatService ChatService
@inject UserManager<ApplicationUser> UserManager
@inject IJSRuntime JS

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    /* ===== TOP BAR ===== */
    .rc-topbar {
        background-color: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        z-index: 1050;
    }

    .rc-topbar-inner {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /* Brand */
    .rc-brand {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        font-weight: 800;
        font-size: 1.35rem;
        color: #2563eb !important;
        text-decoration: none;
        line-height: 1;
    }

        .rc-brand i {
            font-size: 1.45rem;
            color: #2563eb;
        }

        .rc-brand:hover {
            text-decoration: none;
            color: #1d4ed8;
        }

    /* زر الهامبرغر */
    .rc-hamburger-btn {
        border: none;
        background: transparent;
        padding: 0;
        margin-right: .65rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        line-height: 1;
    }

        .rc-hamburger-btn i {
            font-size: 1.7rem;
            color: #111827;
        }

        .rc-hamburger-btn:focus {
            outline: none;
            box-shadow: none;
        }

    .rc-left-group {
        display: flex;
        align-items: center;
        min-width: 0;
    }

    /* Right (اسم المستخدم + أزرار + جرس) */
    .top-right {
        display: flex;
        align-items: center;
        gap: .75rem;
    }

    .top-user-name {
        font-size: .9rem;
        color: #111827;
        white-space: nowrap;
        font-weight: 500;
    }

    .top-auth-btn,
    .top-auth-btn-outline {
        border-radius: 999px;
        font-size: .85rem;
        padding: .35rem .85rem;
    }

    .top-auth-btn-outline {
        border: 1px solid #e5e7eb;
        background-color: #ffffff;
    }

        .top-auth-btn-outline:hover {
            background-color: #f3f4f6;
        }

    .top-auth-btn {
        background-color: #2563eb;
        border-color: #2563eb;
    }

        .top-auth-btn:hover {
            background-color: #1d4ed8;
        }

    @@media (max-width: 575.98px) {
        .top-user-name {
            display: none;
        }
    }

    /* ===== OFFCANVAS MENU ===== */
    .rc-offcanvas {
        width: 270px;
        background-color: #0f172a;
        color: #e5e7eb;
    }

    .rc-offcanvas-header {
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .rc-offcanvas-title {
        font-size: .8rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #9ca3af;
    }

    .rc-nav-section-label {
        font-size: .75rem;
        text-transform: uppercase;
        letter-spacing: .08em;
        color: #6b7280;
        margin: 1rem 0 .25rem;
    }

    .rc-side-nav {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
    }

        .rc-side-nav li {
            margin-bottom: .15rem;
        }

    .rc-side-link {
        display: flex;
        align-items: center;
        gap: .6rem;
        padding: .55rem .75rem;
        border-radius: .55rem;
        color: #e5e7eb;
        text-decoration: none;
        font-size: .9rem;
        transition: background-color .15s ease, color .15s ease, transform .08s ease;
    }

        .rc-side-link i {
            font-size: 1.1rem;
        }

        .rc-side-link:hover {
            background-color: #1f2937;
            color: #ffffff;
            text-decoration: none;
            transform: translateX(1px);
        }

        .rc-side-link.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #ffffff;
        }

    .rc-side-badge {
        margin-left: auto;
        min-width: 20px;
        height: 20px;
        border-radius: 999px;
        font-size: .7rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 .4rem;
    }

    .rc-side-badge-danger {
        background-color: #ef4444;
        color: #fff;
    }

    .rc-side-badge-warning {
        background-color: #f59e0b;
        color: #111827;
    }

    .rc-offcanvas-footer {
        border-top: 1px solid rgba(148, 163, 184, 0.3);
        padding-top: .75rem;
    }

    .rc-user-pill {
        display: flex;
        align-items: center;
        gap: .6rem;
        margin-bottom: .5rem;
    }

    .rc-user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background-color: #2563eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: .9rem;
        font-weight: 600;
        color: #ffffff;
    }

    .rc-user-meta {
        font-size: .8rem;
        line-height: 1.2;
    }

        .rc-user-meta .name {
            font-weight: 600;
        }

        .rc-user-meta .sub {
            color: #9ca3af;
        }

    .rc-logout-btn {
        width: 100%;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background-color: transparent;
        color: #e5e7eb;
        font-size: .85rem;
        padding: .45rem .75rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .35rem;
    }

        .rc-logout-btn:hover {
            background-color: #111827;
        }

    /* ===== CUSTOM OVERLAY (fix stuck shadow) ===== */
    .rc-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        z-index: 1045; /* أقل من offcanvas (عادة 1050) */
    }
</style>

<!-- ===== TOP BAR ===== -->
<header class="rc-topbar shadow-sm sticky-top">
    @if (isMenuOpen)
    {
        <div class="rc-overlay" @onclick="CloseMenuAsync"></div>
    }
    <div class="container-fluid rc-topbar-inner">
        <!-- Left: hamburger + logo -->
        <div class="rc-left-group">

            <button class="rc-hamburger-btn" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#rcMainMenu"
                    aria-controls="rcMainMenu" aria-label="Open navigation"
                    @onclick="OpenMenuAsync">
                <i class="bi bi-list"></i>
            </button>

            <a class="rc-brand" href="/">
                <i class="bi bi-box-seam-fill"></i>
                <span>RentConnect</span>
            </a>

        </div>

        <!-- Right: notifications + user/auth -->
        <div class="top-right">
            <!-- 🔔 Notification bell -->

            <AuthorizeView>
                <Authorized>

                    <NotificationBell UserId="@userId" />

                    <span class="top-user-name">
                        <i class="bi bi-person-circle me-1"></i>@fullName
                    </span>

                    <form action="Account/Logout" method="post" class="d-inline">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                        <button type="submit"
                                class="btn btn-sm top-auth-btn-outline text-danger d-flex align-items-center">
                            <i class="bi bi-box-arrow-right me-1"></i> Logout
                        </button>
                    </form>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="btn btn-sm btn-outline-primary top-auth-btn-outline d-none d-sm-inline-flex"
                             href="Account/Login">
                        <i class="bi bi-box-arrow-in-right me-1"></i> Login
                    </NavLink>
                    <NavLink class="btn btn-sm btn-primary top-auth-btn d-none d-sm-inline-flex"
                             href="Account/Register">
                        <i class="bi bi-person-plus-fill me-1"></i> Sign up
                    </NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
</header>

<!-- ===== OFFCANVAS MENU ===== -->
<div class="offcanvas offcanvas-start rc-offcanvas"
     tabindex="-1"
     id="rcMainMenu"
     data-bs-backdrop="false"
     data-bs-scroll="true"
     aria-labelledby="rcMainMenuLabel">
    <div class="offcanvas-header rc-offcanvas-header">
        <h6 class="rc-offcanvas-title" id="rcMainMenuLabel">
            MAIN MENU
        </h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body d-flex flex-column">
        <div class="mb-2">
            <div class="rc-nav-section-label">Browse</div>
            <ul class="rc-side-nav">
                <li>
                    <NavLink href="/" Match="NavLinkMatch.All" class="rc-side-link">
                        <i class="bi bi-house-door-fill"></i>
                        <span>Home</span>
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/items" class="rc-side-link">
                        <i class="bi bi-grid-3x3-gap-fill"></i>
                        <span>Items</span>
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/favorites" class="rc-side-link">
                        <i class="bi bi-heart-fill"></i>
                        <span>Favorites</span>
                    </NavLink>
                </li>
            </ul>
        </div>

        <AuthorizeView>
            <Authorized>
                <div class="mt-2">
                    <div class="rc-nav-section-label">Bookings & Messages</div>
                    <ul class="rc-side-nav">
                        <li>
                            <NavLink href="/bookings" class="rc-side-link">
                                <i class="bi bi-calendar-check-fill"></i>
                                <span>My bookings</span>
                                @if (myBookingCount > 0)
                                {
                                    <span class="rc-side-badge rc-side-badge-danger">@myBookingCount</span>
                                }
                            </NavLink>
                        </li>
                        <li>
                            <NavLink href="/my-bookings/owner" class="rc-side-link">
                                <i class="bi bi-journal-check"></i>
                                <span>Owner requests</span>
                                @if (ownerRequestsCount > 0)
                                {
                                    <span class="rc-side-badge rc-side-badge-warning">@ownerRequestsCount</span>
                                }
                            </NavLink>
                        </li>
                        <li>
                            <NavLink href="/messages" class="rc-side-link">
                                <i class="bi bi-chat-dots-fill"></i>
                                <span>Messages</span>
                                @if (unreadMessageCount > 0)
                                {
                                    <span class="rc-side-badge rc-side-badge-danger">@unreadMessageCount</span>
                                }
                            </NavLink>
                        </li>
                    </ul>
                </div>

                <div class="mt-2">
                    <div class="rc-nav-section-label">Your items</div>
                    <ul class="rc-side-nav">
                        <li>
                            <NavLink href="/additems" class="rc-side-link">
                                <i class="bi bi-plus-circle-fill"></i>
                                <span>Add item</span>
                            </NavLink>
                        </li>
                        <li>
                            <NavLink href="/profile" class="rc-side-link">
                                <i class="bi bi-person-badge-fill"></i>
                                <span>My profile</span>
                            </NavLink>
                        </li>
                        <AuthorizeView Roles="Admin" Context="adminCtx">
                            <li>
                                <NavLink href="/Admin/Users" class="rc-side-link">
                                    <i class="bi bi-shield-lock-fill"></i>
                                    <span>Admin panel</span>
                                </NavLink>
                            </li>
                        </AuthorizeView>
                    </ul>
                </div>
            </Authorized>
        </AuthorizeView>

        <!-- Info & Support -->
        <div class="mt-2">
            <div class="rc-nav-section-label">Info & Support</div>
            <ul class="rc-side-nav">
                <li>
                    <NavLink href="/about" class="rc-side-link">
                        <i class="bi bi-info-circle-fill"></i>
                        <span>About RentConnect</span>
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/policy" class="rc-side-link">
                        <i class="bi bi-shield-check"></i>
                        <span>Policy</span>
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/contact" class="rc-side-link">
                        <i class="bi bi-envelope-fill"></i>
                        <span>Contact</span>
                    </NavLink>
                </li>
            </ul>
        </div>

        <div class="rc-offcanvas-footer mt-auto">
            <AuthorizeView>
                <Authorized>
                    <div class="rc-user-pill">
                        <div class="rc-user-avatar">
                            @(string.IsNullOrWhiteSpace(fullName) ? "U" : fullName![0])
                        </div>
                        <div class="rc-user-meta">
                            <div class="name">@fullName</div>
                            <div class="sub">Signed in</div>
                        </div>
                    </div>

                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                        <button type="submit" class="rc-logout-btn">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </button>
                    </form>
                </Authorized>
                <NotAuthorized>
                    <div class="d-grid gap-2">
                        <NavLink class="btn btn-sm btn-light" href="Account/Login">
                            <i class="bi bi-box-arrow-in-right me-1"></i> Login
                        </NavLink>
                        <NavLink class="btn btn-sm btn-primary" href="Account/Register">
                            <i class="bi bi-person-plus-fill me-1"></i> Sign up
                        </NavLink>
                    </div>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.rcOffcanvas = {
        show: (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            const inst = bootstrap.Offcanvas.getOrCreateInstance(el);
            inst.show();
        },
        hide: (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            const inst = bootstrap.Offcanvas.getOrCreateInstance(el);
            inst.hide();
        }
    };
</script>

@code {
    private string? currentUrl;
    private int myBookingCount = 0;
    private int ownerRequestsCount = 0;
    private int unreadMessageCount = 0;
    private string? fullName;
    private string? userId;

    private bool isMenuOpen = false;

    private async Task OpenMenuAsync()
    {
        isMenuOpen = true;
        await JS.InvokeVoidAsync("rcOffcanvas.show", "rcMainMenu");
    }

    private async Task CloseMenuAsync()
    {
        isMenuOpen = false;
        await JS.InvokeVoidAsync("rcOffcanvas.hide", "rcMainMenu");
    }

    protected override async Task OnInitializedAsync()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        userId = user?.FindFirst(c => c.Type == "sub")?.Value
                 ?? user?.FindFirst(c => c.Type.Contains("nameidentifier"))?.Value;

        if (!string.IsNullOrEmpty(userId))
        {
            var appUser = await UserManager.FindByIdAsync(userId);
            fullName = appUser?.FullName;

            var myBookings = await BookingService.GetByRenterIdAsync(userId);
            myBookingCount = myBookings.Count(b => b.Status == BookingStatus.Pending);

            var ownerRequests = await BookingService.GetPendingForOwnerAsync(userId);
            ownerRequestsCount = ownerRequests.Count();

            unreadMessageCount = await ChatService.GetUnreadConversationsCountAsync(userId);
        }

        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

   

    

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

   
}